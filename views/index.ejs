<html>
    <head>

    </head>
    <body>
        <h1>Welcome to file service!</h1>
        <h3>upload file</h3>
        File: <input type="file" id="f">
        <button id="uploader">Upload!</button>
        
        <p id="wait">Output</p>

        <script>

            const btn = document.getElementById("uploader");
            const f = document.getElementById("f")
            let wait = document.getElementById("wait")
            let id = Math.random().toString(36).slice(2)

            btn.addEventListener("click", () => {
                console.log("started.")

                const fileReader = new FileReader();
                const theFile = f.files[0];
                const webSocket = new WebSocket('ws://localhost:3001/ws?id=' + id);
                webSocket.onopen = (ev) => {
                    console.log("Connected in realtime... starting upload");
                    fileReader.onload = async ev => {

                        const CHUNK_SIZE = 4096;
                        const chunkCount = ev.target.result.byteLength/CHUNK_SIZE;
                        console.log("Read successfully: chunk size " + chunkCount);
                        const fileName = theFile.name;
                        
                        for (let chunkId=0; chunkId < chunkCount+1; chunkId++){
                            console.log("chunk number: " + chunkId)
                            let chunk = ev.target.result.slice(chunkId * CHUNK_SIZE, (chunkId * CHUNK_SIZE) + CHUNK_SIZE);
                            const raw = JSON.stringify({
                                chunk : Array.from(new Uint8Array(chunk)),
                                fileName : fileName
                            });
                            webSocket.send(raw)
                            await new Promise(r => setTimeout(null, 1000));
                            wait.innerHTML = "Output: " + Math.round(chunkId * 100/Math.floor(chunkCount+1)) + "%"
                        }
                    }
                    fileReader.readAsArrayBuffer(theFile); 
                };
                webSocket.onmessage = (event) => {
                    console.log(event)
                };
            })
        </script>
        
    </body>
</html>